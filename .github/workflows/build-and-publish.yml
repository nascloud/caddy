# .github/workflows/build-and-publish.yml

name: Build and Publish Custom Caddy

on:
  # 当有推送到 main 分支，并且 Dockerfile 文件发生了变化时，触发此工作流
  push:
    branches:
      - 'main'
    paths:
      - 'Dockerfile'
  
  # 允许在 Actions 页面手动触发
  workflow_dispatch:

jobs:
  build-and-publish:
    # 在最新的 Ubuntu 虚拟机上运行
    runs-on: ubuntu-latest

    steps:
      # 步骤1：检出代码
      - name: Checkout repository
        uses: actions/checkout@v4

      # 步骤2：设置 QEMU，这是多平台构建的前提
      # QEMU 可以模拟不同的 CPU 架构，让 amd64 的构建机也能构建 arm64 的镜像
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      # 步骤3：设置 Docker Buildx，一个支持多平台构建的 Docker CLI 插件
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 步骤4：登录到 Docker Hub
      # 使用你在 GitHub Secrets 中存储的凭证
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 步骤5：提取 Docker 元数据（版本号和标签）
      # 这是优化的核心部分，我们精确控制生成的标签
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          # 你的 Docker Hub 镜像仓库名
          images: econome/caddy-dns

          # 从 Dockerfile 的 `FROM` 指令中提取版本号
          # 例如，`FROM caddy:2.7.6` 会提取出 `2.7.6`
          flavor: |
            latest=false
          tags: |
            type=semver,pattern={{version}}
            type=raw,value=latest

      # 步骤6：构建并推送到 Docker Hub
      # 这是另一个优化的核心部分，我们指定了构建平台
      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          # 推送到 Docker Hub
          push: true
          # **指定要构建的平台**
          # 这会构建一个 "fat manifest"，它包含了 amd64 和 arm64 两个平台的镜像
          # Docker 会根据客户端的架构自动拉取正确的镜像
          platforms: linux/amd64,linux/arm64
          # 使用上一步生成的标签 (例如：2.7.6, latest)
          tags: ${{ steps.meta.outputs.tags }}
          # 添加 OCI 规范的标签，增加镜像的元信息
          labels: ${{ steps.meta.outputs.labels }}
          # 开启缓存，可以显著加快后续的构建速度
          cache-from: type=gha
          cache-to: type=gha,mode=max